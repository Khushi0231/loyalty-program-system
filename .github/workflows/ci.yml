name: Loyalty Program CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
  BACKEND_IMAGE: loyalty-backend
  FRONTEND_IMAGE: loyalty-frontend
  DB_IMAGE: loyalty-mysql

jobs:
  backend-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend/loyalty-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build Backend with Maven
        run: mvn clean compile -B
      
      - name: Run Unit Tests
        run: mvn test -B
      
      - name: Generate Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Backend Unit Tests
          path: target/surefire-reports/*.xml
          reporter: java-junit
      
      - name: Build Backend JAR
        run: mvn package -DskipTests -B
      
      - name: Build and Push Backend Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend/loyalty-backend
          push: ${{ github.event_name == 'push' }}
          tags: |
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.BACKEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  frontend-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend/loyalty-frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Run Linting
        run: npm run lint
      
      - name: Run Tests
        run: npm test --if-present
      
      - name: Build Frontend
        run: npm run build
      
      - name: Build and Push Frontend Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend/loyalty-frontend
          push: ${{ github.event_name == 'push' }}
          tags: |
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.FRONTEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  db-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./database/mysql-init
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build and Push MySQL Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./database/mysql-init
          push: ${{ github.event_name == 'push' }}
          tags: |
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.DB_IMAGE }}:${{ github.sha }}
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.DB_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  helm-validation:
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build, db-build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'
      
      - name: Set up Kubernetes
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'
      
      - name: Validate Helm Charts
        run: |
          helm lint helm-charts/loyalty-db-helm
          helm lint helm-charts/loyalty-backend-helm
          helm lint helm-charts/loyalty-frontend-helm
      
      - name: Template Helm Charts
        run: |
          echo "=== Database Helm Template ===" > helm-template-output.txt
          helm template loyalty-db helm-charts/loyalty-db-helm >> helm-template-output.txt
          
          echo -e "\n=== Backend Helm Template ===" >> helm-template-output.txt
          helm template loyalty-backend helm-charts/loyalty-backend-helm >> helm-template-output.txt
          
          echo -e "\n=== Frontend Helm Template ===" >> helm-template-output.txt
          helm template loyalty-frontend helm-charts/loyalty-frontend-helm >> helm-template-output.txt
      
      - name: Upload Helm Template Output
        uses: actions/upload-artifact@v3
        with:
          name: helm-templates
          path: helm-template-output.txt

  deploy-staging:
    runs-on: ubuntu-latest
    needs: helm-validation
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.loyalty.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v3
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
      
      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          kubeconfig: ${{ secrets.KUBECONFIG_STAGING }}
      
      - name: Deploy Database
        run: |
          helm upgrade --install loyalty-db helm-charts/loyalty-db-helm \
            --namespace loyalty \
            --create-namespace \
            --wait
      
      - name: Deploy Backend
        run: |
          helm upgrade --install loyalty-backend helm-charts/loyalty-backend-helm \
            --namespace loyalty \
            --set image.repository=${{ env.DOCKER_HUB_USERNAME }}/${{ env.BACKEND_IMAGE }} \
            --set image.tag=${{ github.sha }} \
            --wait
      
      - name: Deploy Frontend
        run: |
          helm upgrade --install loyalty-frontend helm-charts/loyalty-frontend-helm \
            --namespace loyalty \
            --set image.repository=${{ env.DOCKER_HUB_USERNAME }}/${{ env.FRONTEND_IMAGE }} \
            --set image.tag=${{ github.sha }} \
            --wait
      
      - name: Health Check
        run: |
          kubectl wait --namespace loyalty \
            --for=condition=available \
            deployment/loyalty-backend \
            --timeout=300s
          
          kubectl wait --namespace loyalty \
            --for=condition=available \
            deployment/loyalty-frontend \
            --timeout=300s

  notify:
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build, db-build]
    if: always()
    
    steps:
      - name: Send notification
        if: failure()
        run: |
          echo "Build failed. Sending notification..."
          # Add Slack/email notification logic here
          echo "CI/CD Pipeline completed with failures"
      
      - name: Build summary
        run: |
          echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend Build: ${{ needs.backend-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Build: ${{ needs.frontend-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### Database Build: ${{ needs.db-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### Helm Validation: ${{ needs.helm-validation.result }}" >> $GITHUB_STEP_SUMMARY

